# FRR configuration generated by openshift/machine-config-operator

hostname {{`{{ .ShortHostname }}`}}

log file /var/log/frr/frr.log
log timestamp precision 3

debug zebra events
debug zebra nht
debug zebra kernel
debug zebra rib
debug zebra nexthop
debug bgp neighbor-events
debug bgp updates
debug bgp keepalives
debug bgp nht
debug bgp zebra
debug bfd network
debug bfd peer
debug bfd zebra

ip nht resolve-via-default
ipv6 nht resolve-via-default

router bgp {{`{{ with $bgp := .BGPSpeaker }}{{ $bgp.ASN }}{{ end }}`}}
  no bgp ebgp-requires-policy
  no bgp network import-check
  no bgp default ipv4-unicast
  bgp router-id {{`{{.NonVirtualIP}}`}}
  bgp log-neighbor-changes
  bgp graceful-shutdown

  {{`{{- with $bgp := .BGPSpeaker }}
  {{ range $peer := $bgp.Peers }}
  neighbor {{ $peer.IP }} remote-as {{ $peer.ASN }}
  neighbor {{ $peer.IP }} password {{ $peer.Password }}
  neighbor {{ $peer.IP }} bfd profile openshift-control-plane
  {{ end }}
  {{- end }}`}}

  address-family ipv4 unicast
  {{`{{- with $bgp := .BGPSpeaker }}
  {{ range $peer := $bgp.Peers }}
    neighbor {{ $peer.IP }} activate

  {{ end }}
  {{- end }}`}}
  exit-address-family

  address-family ipv6 unicast
    redistribute connected route-map vip
  {{`{{- with $bgp := .BGPSpeaker -}}
  {{ range $i, $peer := $bgp.Peers }}
    neighbor uplink-{{ $i }} activate
  {{- end -}}
  {{- end }}`}}
  exit-address-family

  address-family l2vpn evpn
  {{`{{- with $bgp := .BGPSpeaker -}}
  {{ range $i, $peer := $bgp.Peers }}
    neighbor uplink-{{ $i }} activate
  {{- end -}}
  {{- end }}`}}
  exit-address-family

bfd
  profile openshift-control-plane
    detect-multiplier 10
    transmit-interval 500
    receive-interval 500

access-list vip seq 1 permit {{`{{ .Cluster.APIVIP }}`}}/{{`{{ .Cluster.VIPNetmask }}`}}

{{`{{- with $bgp := .BGPSpeaker }}
{{ range $i, $peer := $bgp.Peers }}
route-map uplink-{{ $i }}-in deny 20
route-map 
    match ip address vip
