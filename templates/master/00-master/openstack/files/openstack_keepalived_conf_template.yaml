filesystem: "root"
mode: 0755
path: "/etc/kubernetes/static-pod-resources/keepalived/keepalived.conf.template"
contents:
  inline: |
    vrrp_script chk_ocp {
        script "/usr/bin/curl -o /dev/null -kLs https://0:6443/readyz"
        interval 1
        weight 50
    }

    vrrp_script chk_dns {
        script "/usr/bin/host -t SRV _etcd-server-ssl._tcp.${DOMAIN} localhost"
        interval 1
        weight 50
    }

    # vrrp_script chk_ingress {
    #     script "curl -o /dev/null -kLs https://0:1936/healthz"
    #     interval 1
    #     weight 50
    # }
    
    vrrp_instance ${CLUSTER_NAME}_API {
        state BACKUP
        interface ${INTERFACE}
        virtual_router_id ${API_VRID}
        priority 40
        advert_int 1
        authentication {
            auth_type PASS
            auth_pass ${CLUSTER_NAME}_api_vip
        }
        virtual_ipaddress {
            ${API_VIP}/${NET_MASK}
        }
        track_script {
            chk_ocp
        }
    }

    vrrp_instance ${CLUSTER_NAME}_DNS {
        state BACKUP
        interface ${INTERFACE}
        virtual_router_id ${DNS_VRID}
        priority 40
        advert_int 1
        authentication {
            auth_type PASS
            auth_pass ${CLUSTER_NAME}_dns_vip
        }
        virtual_ipaddress {
            ${DNS_VIP}/${NET_MASK}
        }
        track_script {
            chk_dns
        }
    }

    # vrrp_instance ${CLUSTER_NAME}_INGRESS {
    #     state BACKUP
    #     interface ${INTERFACE}
    #     virtual_router_id ${INGRESS_VRID}
    #     priority 40
    #     advert_int 1
    #     authentication {
    #         auth_type PASS
    #         auth_pass ${CLUSTER_NAME}_ingress_vip
    #     }
    #     virtual_ipaddress {
    #         ${INGRESS_VIP}/${NET_MASK}
    #     }
    #     track_script {
    #         chk_ingress
    #     }
    # }
