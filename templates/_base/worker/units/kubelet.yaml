name: "kubelet.service"
enabled: true
contents: |
  [Unit]
  Description=Kubernetes Kubelet
  Wants=rpc-statd.service

  [Service]
  ExecStartPre=/bin/mkdir --parents /etc/kubernetes/manifests
  EnvironmentFile=-/etc/kubernetes/kubelet-workaround

  ExecStart=/usr/bin/hyperkube \
      kubelet \
        --bootstrap-kubeconfig=/etc/kubernetes/kubeconfig \
        --kubeconfig=/var/lib/kubelet/kubeconfig \
        --rotate-certificates \
        --network-plugin=cni \
        --lock-file=/var/run/lock/kubelet.lock \
        --exit-on-lock-contention \
        --pod-manifest-path=/etc/kubernetes/manifests \
        --allow-privileged \
        --node-labels=node-role.kubernetes.io/worker \
        --minimum-container-ttl-duration=6m0s \
        --cluster-dns={{.ClusterDNSIP}} \
        --cluster-domain=cluster.local \
        --client-ca-file=/etc/kubernetes/ca.crt \
        --cloud-provider={{cloudProvider .}} \
        {{.CloudProviderConfig}} \
        --anonymous-auth=false \
      --cgroup-driver=systemd \

  Restart=always
  RestartSec=10

  [Install]
  WantedBy=multi-user.target
