name: "machine-config-daemon-pull.service"
enabled: true
contents: |
  [Unit]
  Description=Machine Config Daemon Pull
  # Make sure it runs only on OSTree booted system
  ConditionPathExists=/run/ostree-booted
  # This "stamp file" is unlinked when we complete
  # machine-config-daemon-firstboot.service
  ConditionPathExists=/etc/ignition-machine-config-encapsulated.json
  # Run after crio-wipe so the pulled MCD image is protected against a corrupted storage from a forced shutdown
  Wants=network-online.target crio-wipe.service
  After=network-online.target crio-wipe.service

  [Service]
  Type=oneshot
  RemainAfterExit=yes
  # See https://github.com/coreos/fedora-coreos-tracker/issues/354
  ExecStart=/bin/sh -c '/bin/mkdir -p /run/bin && chcon --reference=/usr/bin /run/bin'
  ExecStart=/bin/sh -c 'nslookup quay.io || true'
  ExecStart=/bin/sh -c 'host quay.io || true'
  ExecStart=/bin/sh -c 'ip -d -s link show; ip addr show; ip route show'
  ExecStart=/bin/sh -c "while ! /usr/bin/podman pull --authfile=/var/lib/kubelet/config.json '{{ .Images.machineConfigOperator }}'; do sleep 1; done"
  ExecStart=/bin/sh -c "ss -anpei || true"
  ExecStart=/bin/sh -c "ip -d -s link show; ip -6 addr show; ip -6 route show; ip addr show; ip route show"
  ExecStart=/bin/sh -c "/usr/bin/podman run --rm --quiet --net=host --entrypoint=cat '{{ .Images.machineConfigOperator }}' /usr/bin/machine-config-daemon > /run/bin/machine-config-daemon.tmp"
  ExecStart=/bin/sh -c '/usr/bin/chmod a+x /run/bin/machine-config-daemon.tmp && mv /run/bin/machine-config-daemon.tmp /run/bin/machine-config-daemon'
  {{if .Proxy -}}
  EnvironmentFile=/etc/mco/proxy.env
  {{end -}}

  [Install]
  RequiredBy=machine-config-daemon-firstboot.service
