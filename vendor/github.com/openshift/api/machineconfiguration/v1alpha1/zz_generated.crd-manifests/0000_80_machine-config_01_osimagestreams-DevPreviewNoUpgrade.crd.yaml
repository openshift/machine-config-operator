apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    api-approved.openshift.io: https://github.com/openshift/api/pull/2555
    api.openshift.io/merged-by-featuregates: "true"
    include.release.openshift.io/ibm-cloud-managed: "true"
    include.release.openshift.io/self-managed-high-availability: "true"
    release.openshift.io/feature-set: DevPreviewNoUpgrade
  labels:
    openshift.io/operator-managed: ""
  name: osimagestreams.machineconfiguration.openshift.io
spec:
  group: machineconfiguration.openshift.io
  names:
    kind: OSImageStream
    listKind: OSImageStreamList
    plural: osimagestreams
    singular: osimagestream
  scope: Cluster
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          OSImageStream describes a set of streams and associated URLs available
          for the MachineConfigPools to be used as base OS images.

          Compatibility level 4: No compatibility is provided, the API can change at any point for any reason. These capabilities should not be used by applications needing long term support.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: spec contains the desired OSImageStream config configuration.
            type: object
          status:
            description: |-
              status describes the last observed state of this OSImageStream.
              Populated by the MachineConfigOperator after reading release metadata.
              When not present, the controller has not yet reconciled this resource.
            properties:
              availableStreams:
                description: |-
                  availableStreams is a list of the available OS Image Streams
                  available and their associated URLs for both OS and Extensions
                  images.

                  A maximum of 100 streams may be specified.
                items:
                  properties:
                    name:
                      description: |-
                        name is the identifier of the stream.

                        Must not be empty and must not exceed 70 characters in length.
                        Must only contain alphanumeric characters, hyphens ('-'), or dots ('.').
                      maxLength: 70
                      minLength: 1
                      type: string
                      x-kubernetes-validations:
                      - message: The name must consist only of alphanumeric characters,
                          hyphens ('-') and dots ('.').
                        rule: self.matches('^[\\w\\.\\-]+$')
                    osExtensionsImageUrl:
                      description: |-
                        osExtensionsImageUrl is an OS Extensions Image referenced by digest.

                        The format of the URL ref is:
                        host[:port][/namespace]/name@sha256:<digest>
                      maxLength: 447
                      minLength: 1
                      type: string
                      x-kubernetes-validations:
                      - message: the OCI Image reference must end with a valid '@sha256:<digest>'
                          suffix, where '<digest>' is 64 characters long
                        rule: self.split('@').size() == 2 && self.split('@')[1].matches('^sha256:[a-f0-9]{64}$')
                      - message: the OCI Image name should follow the host[:port][/namespace]/name
                          format, resembling a valid URL without the scheme
                        rule: self.split('@')[0].matches('^([a-zA-Z0-9-]+\\.)+[a-zA-Z0-9-]+(:[0-9]{2,5})?/([a-zA-Z0-9-_]{0,61}/)?[a-zA-Z0-9-_.]*?$')
                    osImageUrl:
                      description: |-
                        osImageUrl is an OS Image referenced by digest.

                        The format of the URL ref is:
                        host[:port][/namespace]/name@sha256:<digest>
                      maxLength: 447
                      minLength: 1
                      type: string
                      x-kubernetes-validations:
                      - message: the OCI Image reference must end with a valid '@sha256:<digest>'
                          suffix, where '<digest>' is 64 characters long
                        rule: self.split('@').size() == 2 && self.split('@')[1].matches('^sha256:[a-f0-9]{64}$')
                      - message: the OCI Image name should follow the host[:port][/namespace]/name
                          format, resembling a valid URL without the scheme
                        rule: self.split('@')[0].matches('^([a-zA-Z0-9-]+\\.)+[a-zA-Z0-9-]+(:[0-9]{2,5})?/([a-zA-Z0-9-_]{0,61}/)?[a-zA-Z0-9-_.]*?$')
                  required:
                  - name
                  - osExtensionsImageUrl
                  - osImageUrl
                  type: object
                maxItems: 100
                minItems: 1
                type: array
                x-kubernetes-list-map-keys:
                - name
                x-kubernetes-list-type: map
              defaultStream:
                description: |-
                  defaultStream is the name of the stream that should be used as the default
                  when no specific stream is requested by a MachineConfigPool.
                  Must reference the name of one of the streams in availableStreams.
                  Must be set when availableStreams is not empty.
                  When not set and availableStreams is empty, controllers should use the default one stated in the release image.
                maxLength: 70
                minLength: 1
                type: string
                x-kubernetes-validations:
                - message: The name must consist only of alphanumeric characters,
                    hyphens ('-') and dots ('.').
                  rule: self.matches('^[\\w\\.\\-]+$')
            type: object
            x-kubernetes-validations:
            - message: defaultStream must be set when availableStreams is not empty
              rule: '!has(self.availableStreams) || size(self.availableStreams) ==
                0 || (has(self.defaultStream) && size(self.defaultStream) != 0)'
            - message: defaultStream must reference a stream name from availableStreams
              rule: '!has(self.defaultStream) || self.defaultStream in self.availableStreams.map(s,
                s.name)'
        required:
        - spec
        type: object
        x-kubernetes-validations:
        - message: osimagestream is a singleton, .metadata.name must be 'cluster'
          rule: self.metadata.name == 'cluster'
    served: true
    storage: true
    subresources:
      status: {}
