apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    api-approved.openshift.io: https://github.com/openshift/api/pull/2564
    api.openshift.io/merged-by-featuregates: "true"
    include.release.openshift.io/ibm-cloud-managed: "true"
    include.release.openshift.io/self-managed-high-availability: "true"
    release.openshift.io/feature-gate: ClusterAPIMachineManagement
    release.openshift.io/feature-set: DevPreviewNoUpgrade
  name: clusterapis.operator.openshift.io
spec:
  group: operator.openshift.io
  names:
    kind: ClusterAPI
    listKind: ClusterAPIList
    plural: clusterapis
    singular: clusterapi
  scope: Cluster
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          ClusterAPI provides configuration for the capi-operator.

          Compatibility level 4: No compatibility is provided, the API can change at any point for any reason. These capabilities should not be used by applications needing long term support.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: spec is the specification of the desired behavior of the
              capi-operator.
            minProperties: 0
            properties:
              unmanagedCustomResourceDefinitions:
                description: |-
                  unmanagedCustomResourceDefinitions is a list of ClusterResourceDefinition (CRD)
                  names that should not be managed by the capi-operator installer
                  controller. This allows external actors to own specific CRDs while
                  capi-operator manages others.

                  Each CRD name must be a valid DNS-1123 subdomain consisting of lowercase
                  alphanumeric characters, '-' or '.', and must start and end with an
                  alphanumeric character, with a maximum length of 253 characters.
                  CRD names must contain at least two '.' characters.
                  Example: "clusters.cluster.x-k8s.io"

                  Items cannot be removed from this list once added.

                  The maximum number of unmanagedCustomResourceDefinitions is 128.
                items:
                  maxLength: 253
                  minLength: 1
                  type: string
                  x-kubernetes-validations:
                  - message: a lowercase RFC 1123 subdomain must consist of lower
                      case alphanumeric characters, '-' or '.', and must start and
                      end with an alphanumeric character.
                    rule: '!format.dns1123Subdomain().validate(self).hasValue()'
                  - message: CRD names must contain at least two '.' characters.
                    rule: self.split('.').size() > 2
                maxItems: 128
                minItems: 1
                type: array
                x-kubernetes-list-type: set
                x-kubernetes-validations:
                - message: items cannot be removed from unmanagedCustomResourceDefinitions
                    list
                  rule: oldSelf.all(item, item in self)
            type: object
            x-kubernetes-validations:
            - message: unmanagedCustomResourceDefinitions cannot be unset once set
              rule: '!has(oldSelf.unmanagedCustomResourceDefinitions) || has(self.unmanagedCustomResourceDefinitions)'
          status:
            description: status defines the observed status of the capi-operator.
            properties:
              currentRevision:
                description: |-
                  currentRevision is the name of the most recently fully applied revision.
                  It is written by the installer controller. If it is absent, it indicates
                  that no revision has been fully applied yet.
                  If set, currentRevision must correspond to an entry in the revisions list.
                maxLength: 255
                minLength: 1
                type: string
              desiredRevision:
                description: |-
                  desiredRevision is the name of the desired revision. It is written by the
                  revision controller. It must be set to the name of the entry in the
                  revisions list with the highest revision number.
                maxLength: 255
                minLength: 1
                type: string
              revisions:
                description: |-
                  revisions is a list of all currently active revisions. A revision is
                  active until the installer controller updates currentRevision to a later
                  revision. It is written by the revision controller.

                  The maximum number of revisions is 16.
                  All revisions must have a unique name.
                  All revisions must have a unique revision number.
                  When adding a revision, the revision number must be greater than the highest revision number in the list.
                  Revisions are immutable, although they can be deleted.
                items:
                  properties:
                    components:
                      description: |-
                        components is list of components which will be installed by this
                        revision. Components will be installed in the order they are listed.

                        The maximum number of components is 32.
                      items:
                        description: ClusterAPIInstallerComponent defines a component
                          which will be installed by this revision.
                        properties:
                          image:
                            description: |-
                              image defines an image source for a component. The image must contain a
                              /capi-operator-installer directory containing the component manifests.
                            properties:
                              profile:
                                description: |-
                                  profile is the name of a profile to use from the image.

                                  A profile name may be up to 255 characters long. It must consist of alphanumeric characters, '-', or '_'.
                                maxLength: 255
                                minLength: 1
                                type: string
                                x-kubernetes-validations:
                                - message: profile must consist of alphanumeric characters,
                                    '-', or '_'
                                  rule: self.matches('^[a-zA-Z0-9-_]+$')
                              ref:
                                description: |-
                                  ref is an image reference to the image containing the component manifests. The reference
                                  must be a valid image digest reference in the format host[:port][/namespace]/name@sha256:<digest>.
                                  The digest must be 64 characters long, and consist only of lowercase hexadecimal characters, a-f and 0-9.
                                  The length of the field must be between 1 to 447 characters.
                                maxLength: 447
                                minLength: 1
                                type: string
                                x-kubernetes-validations:
                                - message: the OCI Image reference must end with a
                                    valid '@sha256:<digest>' suffix, where '<digest>'
                                    is 64 characters long
                                  rule: (self.split('@').size() == 2 && self.split('@')[1].matches('^sha256:[a-f0-9]{64}$'))
                                - message: the OCI Image name should follow the host[:port][/namespace]/name
                                    format, resembling a valid URL without the scheme
                                  rule: (self.split('@')[0].matches('^([a-zA-Z0-9-]+\\.)+[a-zA-Z0-9-]+(:[0-9]{2,5})?/([a-zA-Z0-9-_]{0,61}/)?[a-zA-Z0-9-_.]*?$'))
                            required:
                            - profile
                            - ref
                            type: object
                          type:
                            description: |-
                              type is the source type of the component.
                              The only valid value is Image.
                              When set to Image, the image field must be set and will define an image source for the component.
                            enum:
                            - Image
                            type: string
                        required:
                        - type
                        type: object
                        x-kubernetes-validations:
                        - message: image is required when type is Image, and forbidden
                            otherwise
                          rule: 'self.type == ''Image'' ? has(self.image) : !has(self.image)'
                      maxItems: 32
                      minItems: 1
                      type: array
                      x-kubernetes-list-type: atomic
                    contentID:
                      description: |-
                        contentID uniquely identifies the content of this revision.
                        The contentID must be between 1 and 255 characters long.
                      maxLength: 255
                      minLength: 1
                      type: string
                    name:
                      description: name is the name of a revision.
                      maxLength: 255
                      minLength: 1
                      type: string
                    revision:
                      description: revision is a monotonically increasing number that
                        is assigned to a revision.
                      format: int64
                      minimum: 1
                      type: integer
                    unmanagedCustomResourceDefinitions:
                      description: |-
                        unmanagedCustomResourceDefinitions is a list of the names of
                        ClusterResourceDefinition (CRD) objects which are included in this
                        revision, but which should not be installed or updated. If not set, all
                        CRDs in the revision will be managed by the CAPI operator.
                      items:
                        maxLength: 253
                        minLength: 1
                        type: string
                        x-kubernetes-validations:
                        - message: a lowercase RFC 1123 subdomain must consist of
                            lower case alphanumeric characters, '-' or '.', and must
                            start and end with an alphanumeric character.
                          rule: '!format.dns1123Subdomain().validate(self).hasValue()'
                      maxItems: 128
                      minItems: 1
                      type: array
                      x-kubernetes-list-type: atomic
                  required:
                  - components
                  - contentID
                  - name
                  - revision
                  type: object
                  x-kubernetes-map-type: atomic
                maxItems: 16
                minItems: 1
                type: array
                x-kubernetes-list-type: atomic
                x-kubernetes-validations:
                - message: each revision must have a unique name
                  rule: self.all(x, self.exists_one(y, x.name == y.name))
                - message: each revision must have a unique revision number
                  rule: self.all(x, self.exists_one(y, x.revision == y.revision))
                - message: new revisions must have a revision number greater than
                    all existing revisions
                  rule: self.all(new, oldSelf.exists(old, old.name == new.name) ||
                    oldSelf.all(old, new.revision > old.revision))
                - message: existing revisions are immutable, but may be removed
                  rule: oldSelf.all(old, !self.exists(new, new.name == old.name) ||
                    self.exists(new, new == old))
            required:
            - desiredRevision
            - revisions
            type: object
            x-kubernetes-validations:
            - message: desiredRevision must be the name of the revision with the highest
                revision number
              rule: self.revisions.exists(r, r.name == self.desiredRevision && self.revisions.all(s,
                s.revision <= r.revision))
            - message: currentRevision must correspond to an entry in the revisions
                list
              rule: '!has(self.currentRevision) || self.revisions.exists(r, r.name
                == self.currentRevision)'
        required:
        - metadata
        - spec
        type: object
        x-kubernetes-validations:
        - message: clusterapi is a singleton, .metadata.name must be 'cluster'
          rule: self.metadata.name == 'cluster'
    served: true
    storage: true
    subresources:
      status: {}
